
# Инструкция разработчика

- [Инструкция разработчика](#инструкция-разработчика)
  - [Установка для разработки](#установка-для-разработки)
    - [Установить python](#установить-python)
      - [Windows](#windows)
      - [Ubuntu](#ubuntu)
    - [Установить git](#установить-git)
    - [Установить исходный код](#установить-исходный-код)
    - [Проверить установку](#проверить-установку)
  - [Внесение модификаций](#внесение-модификаций)
    - [Создать новую ветку git](#создать-новую-ветку-git)
    - [Добавление новых форматов выписки](#добавление-новых-форматов-выписки)
      - [Шаг 1. Создать новый модуль типа extractor\_XXXX.py](#шаг-1-создать-новый-модуль-типа-extractor_xxxxpy)
      - [Шаг 2. Зарегистрировать модуль экстрактора](#шаг-2-зарегистрировать-модуль-экстрактора)
      - [Шаг 3. Документация](#шаг-3-документация)
  - [Создание запускаемого файла .exe](#создание-запускаемого-файла-exe)




## Установка для разработки

### Установить python 

#### Windows

Скачать и установить python с https://www.python.org/

#### Ubuntu

```
sudo apt-get install -y python3.12
sudo apt-get install -y python3.12-venv
sudo apt-get install python3.12-tk
sudo apt-get install python3.12-dev
```

### Установить git

Установите систему управления версиями [git](https://git-scm.com/downloads).


### Установить исходный код

Склонировать исходный код с github и перейти в созданную при этом директорию
``` 
git clone https://github.com/Ev2geny/Sberbank2Excel.git 
cd Sberbank2Excel
```

создать виртуальную среду
```
python3.12 -m venv .venv
```
активировать виртуальную среду

*Unbuntu*:
```
source .venv/bin/activate
```

*Windows*:
```
.venv\Scripts\Activate
```
Перейти в git ветку `develop`

```
git switch develop
```

Установить пакет Sberbank2Excel в формате разработки.
```
python -m pip install -e .[dev]
```

### Проверить установку

Запустить тесты.  
Режим "not private" избегает запускать тесты, промаркированные как `private`. Это те тесты, для работы которых требуется
приватные варианты выписок, недоступные в исходном коде (а таких - большинство)
```
python -m pytest -m "not private"
```
Убедиться, что в директории `tests/test_data` созданы файлы `.xlsx`

Запустить `sberbank2Excel` как модуль и убедиться, что он запускается

```
python -m Sberbank2Excel.sberbank2Excel
```

Запустить `sberbankPDF2Excel` из командной строки и убедиться, что он запускается

Прим.: запускаемый файл `sberbankPDF2Excel` (`sberbankPDF2Excel.exe` Windows) должен был быть создан установке пакета 
при помощи pip (см. выше), но это не полноценный .exe файл, создаваемый при помощи утилиты `pyinstaller`
  

```
sberbank2Excel
```


## Внесение модификаций

### Создать новую ветку git


Если в планах сделать [Pull Request](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests) то создайте новую ветку git.   
Например:

```
git switch -c issue_xxx
```

Для того чтобы ссылаться на [github issue](https://github.com/Ev2geny/Sberbank2Excel/issues), хорошо его создать заранее и описать там проблему / улучшение, которое вы собираетесь решать.


### Добавление новых форматов выписки

Sberbank2Excel имеет модульную конструкцию, где для каждого типа выписки имеется отдельный модуль.

Таким образом для того чтобы добавить поддержку нового формата выписки необходимо создать и зарегистрировать новый модуль экстрактора.

Следует отметить, что т.к. Sberbank2Excel сначала преобразует PDF файл в промежуточный текстовый файл, то создавать новый 
модуль имеет практический смысл только для PDF формата, информация в котором представлена в виде виртульных строк. Это условие пока что выполняется для всех известных вариантов выписок Сбера, но может не выполняться для других банков, например похоже не выполняется для [ВТБ](https://github.com/Ev2geny/Sberbank2Excel/issues/37)

#### Шаг 1. Создать новый модуль типа extractor_XXXX.py

Модуль типа `extractor_XXXX.py` должен содержать класс, который наследует от абстрактного класса [`Extractor`](src/Sberbank2Excel/extractor.py) и должен содержать реазизицию всех абстрактных методов этого класса.

Проще всего скопировать один из существующих экстракторов (лучше наиболее близкий к тому, который вы хотите создать) и изменить код так, чтобы он соответствовал бы новому типу выписки.

Для облегчения разработки модули экстракторов содержат код для самотестирования, который работает, когда [модуль запускается в качестве основной программы](https://coderoad.ru/419163/%D0%A7%D1%82%D0%BE-%D0%B4%D0%B5%D0%BB%D0%B0%D0%B5%D1%82-if-__name__-__main__-do)  
```py 
if __name__ == '__main__':
```

Шаги по создания нового модуля экстрактора:

**Шаг 1.1** Скопировать наиболее близкий из уже имеющихся экстракторов ( например [`extractor_SBER_CREDIT_2110.py`](src/Sberbank2Excel/extractor_SBER_CREDIT_2110.py)) под новым именем.

**Шаг 1.2** В только что созданном модуле переименовать `class SBER_CREDIT_2107(Extractor)` (к примеру `class SOME_NEW_FORMAT(Extractor)`)

**Шаг 1.3** Внести новое имя класса в самом низу модуля в строку, которая запускает автотестирование

```py
extractors_generic.debug_extractor(SBER_CREDIT_2107, test_text_file_name=sys.argv[1])
```

**Шаг 1.4** Внести необходимые изменения в методы класса `SOME_NEW_FORMAT`, используя информацию из комментариев. Методы можно переписывать по одному, последовательно проверяя их запуская модуль из командной строки в качестве основной программы. При запуске модуля в качестве аргумента надо указать файл предварительно созданного промежуточного текстового варианта выписки (промежуточный текстовый вариант выписку будет создан автоматически при попытке сконвертировать неизвестный формат).

``` py extractor_XXXXXX.py bank_extract_converted_to_txt.txt ```

Это будет запускать функцию `extractors_generic.debug_extractor`, которая сама расскажет, что она делает. В конечном итоге функция `extractors_generic.debug_extractor` должна отрабатывать без ошибок.

#### Шаг 2. Зарегистрировать модуль экстрактора
После того как новый модуль экстрактора полностью протестирован изолированно, его надо зарегистрировать в модуле [`extractors.py`](src/Sberbank2Excel/extractors.py), используя в качестве образца уже зарегистрированные экстракторы

Теперь можно приступать к тестированию, пытаясь сконвертируя выписку обычным способом.

#### Шаг 3. Документация
Если в планах сделать [github pull request](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests), то необходимо так же приложить анонимизированный графический образец новой выписки (см. [примеры](docs/format_examples))

Пример полного набора изменений для добавления одного формата выписки можно посмотреть в [этом коммите](https://github.com/Ev2geny/Sberbank2Excel/commit/0f6c85e4b042ab088b89d5ea1dfe13fcf6f13037)

## Создание запускаемого файла .exe

Активировать виртульную среду (см. выше)

Запустить

```
pyinstaller src/Sberbank2Excel/sberbankPDF2ExcelGUI.py
```
Проверить наличие и протестировать .exe файл в директории `dist`